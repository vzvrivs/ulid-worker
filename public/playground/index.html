<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <script>
    try {
      const theme = localStorage.getItem('theme');
      if (theme) document.documentElement.setAttribute('data-theme', theme);
    } catch (e) {}
  </script>
  <title>ULID Playground</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <script>
    (function(){
      let mode = localStorage.getItem('ulidw-theme-mode') || "auto";
      let themeLight = localStorage.getItem('ulidw-theme-light') || "light";
      let themeDark  = localStorage.getItem('ulidw-theme-dark')  || "dark";
      let prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      let theme;
      if (mode === "auto") theme = prefersDark ? themeDark : themeLight;
      else if (mode === "manual") theme = localStorage.getItem("ulidw-theme-last") || themeDark;
      else if (mode === "light") theme = themeLight;
      else if (mode === "dark") theme = themeDark;
      else theme = "light";
      document.documentElement.setAttribute("data-theme", theme);
      // Si th√®me custom, cache tout tant que JS n'a pas inject√© le style
      try {
        const customs = JSON.parse(localStorage.getItem("ulidw-user-themes") || "[]");
        if (Array.isArray(customs) && customs.find(t => t.name === theme)) {
          document.documentElement.style.visibility = "hidden";
          window.__ulidw_theme_pending = true;
        }
      } catch(e){}
    })();
  </script>

  <!-- ton CSS -->
  <link rel="stylesheet" href="/style.css"/>

</head>

<body>

  <header id="nav-container" class="header-nav-container"></header>

  <main class="page-wrapper">

    <h1>üéõÔ∏è ULID Playground</h1>
    <p>Testez, exp√©rimentez et manipulez vos ULID en temps r√©el.</p>
    <p>G√©n√©rez des ULID triables, remplissez vos structures JSON, validez leur conformit√©.</p>
    <p>Tout ce que vous voyez ici est aussi disponible via API.</p>

    <!-- ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë -->
    <!-- ‚ñë‚ñë‚ñë 1. V√©rificateur ULID ‚ñë‚ñë‚ñë -->
    <!-- ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë -->
    <section class="component">
      <h2>üîç V√©rificateur ULID</h2>
      <div class="row">

          <!-- Bloc 1 : V√©rificateur Entr√©e -->
          <div>
            <div id="check-params" class="odd-bloc">
              <div class="field-pair">
                <div>
                  <label for="check-input">ULID √† v√©rifier :</label>
                  <input id="check-input" type="text" placeholder="01JR‚Ä¶">
                </div>
              </div>
              <div class="btn-row">
                <button type="button" id="paste-ulid-btn" aria-label="Coller un ULID">
                  <span class="btn-icon">üì•</span>
                  <span class="btn-label">Coller</span>
                </button>
                <button data-action="clear" data-target="check-input" type="button" aria-label="Effacer l'ULID saisi">
                  <span class="btn-icon">üßº</span>
                  <span class="btn-label">Effacer</span>
                </button>
                <button type="button" id="check-btn" class="btn-action" aria-label="V√©rifier l'ULID saisi">
                  <span class="btn-icon">‚úÖ</span>
                  <span class="btn-label">V√©rifier</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Bloc 2 : V√©rificateur Sortie -->
          <div>
            <div class="even-bloc">
              <label for="check-output">R√©sultat :</label>
              <pre id="check-output" class="code-block">// En attente</pre>
              <div class="btn-row">
                <button data-action="copy" data-target="check-output" type="button" aria-label="Copier les r√©sultats de v√©rification">
                  <span class="btn-icon">üìã</span>
                  <span class="btn-label">Copier</span>
                </button>
                <button data-action="clear" data-target="check-output" type="button" aria-label="Effacer les r√©sultats de v√©rification">
                  <span class="btn-icon">üßπ</span>
                  <span class="btn-label">Effacer</span>
                </button>
              </div>
              <pre id="check-ts-preview" class="code-block ts-preview">üìÜ Date : ‚Äî</pre>
            </div>
          </div>

          <!-- Bloc 3 : V√©rificateur Requ√™te -->
          <div class="span-full even-bloc">
            <h3>üì® Requ√™te de v√©rification :</h3>
            <pre id="req-check" class="code-block">// En attente</pre>
            <div class="controls-row">
              <button data-action="copy" data-target="req-check" type="button" aria-label="Copier la requ√™te de v√©rification">
                <span class="btn-icon">üìã</span>
                <span class="btn-label">Copier</span>
              </button>
              <button data-action="clear" data-target="req-check" type="button" aria-label="Effacer la requ√™te de v√©rification">
                <span class="btn-icon">üßπ</span>
                <span class="btn-label">Effacer</span>
              </button>
            </div>
          </div>

      </div>
    </section>

    <!-- ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë -->
    <!-- ‚ñë‚ñë‚ñë 2. G√©n√©rateur ‚ñë‚ñë‚ñë -->
    <!-- ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë -->
    <section class="component">
      <h2>üé≤ G√©n√©rateur ULID</h2>
      <div class="row">

        <!-- Bloc 1.1 : G√©n√©rateur Params -->
        <div>

          <!-- 1.1 Nombre et format -->
          <div class="field-pair odd-bloc">
            <div>
              <label for="gen-count">Nombre d'ULID :</label>
              <input id="gen-count" type="number" value="5" min="1" max="1000">
            </div>
            <div>
              <label for="gen-format">G√©n√©rer du :</label>
              <select id="gen-format">
                <option value="json">JSON</option>
                <option value="csv">CSV</option>
                <option value="tsv">TSV</option>
                <option value="text">Text</option>
                <option value="joined">Joined</option>
              </select>
            </div>
          </div>

          <!-- 1.1 Cl√©s √† g√©n√©rer -->
          <div id="gen-keys">

            <label for="gen-keys" class="sortable-list even-bloc">

              <span class="span-list-title">Cl√©s √† g√©n√©rer</span>

              <div class="list-item">
                <div class="left-group">
                  <input type="checkbox" id="gen-key-unix" checked>
                  <label for="gen-key-unix">t (UNIX)</label>
                </div>
                <div class="move-controls">
                  <button type="button" class="up-btn">‚ñ≤</button>
                  <button type="button" class="down-btn">‚ñº</button>
                </div>
              </div>

              <div class="list-item">
                <div class="left-group">
                  <input type="checkbox" id="gen-key-iso" checked>
                  <label for="gen-key-iso">ts (ISO 8601)</label>
                </div>
                <div class="move-controls">
                  <button type="button" class="up-btn">‚ñ≤</button>
                  <button type="button" class="down-btn">‚ñº</button>
                </div>
              </div>
              
              <div class="list-item">
                <div class="left-group">
                  <input type="checkbox" id="gen-key-ulid" checked>
                  <label for="gen-key-ulid">ulid (Base32/Hexa - Bin)</label>
                </div>
                <div class="move-controls">
                  <button type="button" class="up-btn">‚ñ≤</button>
                  <button type="button" class="down-btn">‚ñº</button>
                </div>
              </div>

            </label>

          </div>

          <!-- 1.1 Base et binaire -->
          <div class="field-pair odd-bloc">
            <div>
              <label for="gen-base">Base :</label>
              <select id="gen-base">
                <option value="crockford">Base32 (Crockford)</option>
                <option value="hex">Hexa</option>
              </select>
            </div>
            <label for="gen-bin" class="checkbox-stack">
              <span>Inclure binaire</span>
              <input type="checkbox" id="gen-bin">
            </label>
          </div>

          <!-- 1.1 Timestamp commun -->
          <div>
            <label for="gen-ts-common-selectbox" class="checkbox-stack even-bloc">
              <span>Timestamp commun</span>
              <div id="gen-ts-common-selectbox" class="ts-select">
                <div class="option selected" data-value="no">Non</div>
                <div class="option" data-value="now">Maintenant</div>
                <div class="option" data-value="custom">Personnalis√©</div>
              </div>
            </label>
          </div>

          <!-- 1.1 Type + valeur du timestamp custom -->
          <div class="ts-radio-group odd-bloc">
            <label class="ts-radio-line">
              <input type="radio" id="gen-ts-type-unix" name="ts-type" value="unix">
              <span class="label">UNIX (ms)</span>
              <input id="gen-ts-input-unix" class="ts-input" placeholder="299575380000" readonly>
              <span id="gen-ts-valid-unix" class="ts-valid"></span>
            </label>
            <label class="ts-radio-line">
              <input type="radio" id="gen-ts-type-iso" name="ts-type" value="iso" checked>
              <span class="label">ISO 8601</span>
              <input id="gen-ts-input-iso" class="ts-input" placeholder="1979-06-30T07:23:00.000Z" readonly>
              <span id="gen-ts-valid-iso" class="ts-valid"></span>
            </label>
            <label class="ts-radio-line">
              <input type="radio" id="gen-ts-type-crock" name="ts-type" value="crock">
              <span class="label">Crockford</span>
              <input id="gen-ts-input-crock" class="ts-input" placeholder="01HZY9AJ4Z" readonly>
              <span id="gen-ts-valid-crock" class="ts-valid"></span>
            </label>
          </div>
          
          <!-- 1.1 Bouton ¬´ Maintenant ¬ª + date humanis√©e -->
          <div class="even-bloc">
            <button type="button" id="gen-ts-now" class="maintenant-btn" aria-label="Remplir avec la date et l'heure actuelle">‚è≤Ô∏è Maintenant</button>
            <pre id="gen-ts-preview" class="code-block ts-preview">üìÜ Date : ‚Äî</pre>
          </div>

          <!-- 1.1 ULID monotone -->
          <div class="field-pair odd-bloc">
            <label for="gen-monotonic-ulid" class="checkbox-stack">
              <span>ULID monotones</span>
              <input type="checkbox" id="gen-monotonic-ulid">
            </label>
          </div>
          
        </div>

        <!-- Bloc 2 : G√©n√©rateur Sortie -->
        <div>

          <!-- 1.2 Bouton de g√©n√©ration -->
          <div class="controls-row">
            <button type="button" id="generate-btn" class="btn-action" aria-label="G√©n√©rer des ULID">
              <span class="btn-icon">üé≤</span>
              <span class="btn-label">G√©n√©rer</span>
            </button>
          </div>

          <!-- 1.2 Bloc de sortie -->
          <div class="even-bloc">
            <label for="gen-output">ULID g√©n√©r√©s‚ÄØ:</label>
            <pre id="gen-output" class="code-block-out-gen">// En attente</pre>

            <div class="action-container">
              <div class="action-pair">
                <button data-action="copy" data-target="gen-output" type="button" aria-label="Copier les ULID g√©n√©r√©s">
                  <span class="btn-icon">üìã</span>
                  <span class="btn-label">Copier</span>
                </button>
                <button data-action="clear" data-target="gen-output" type="button" aria-label="Effacer les ULID g√©n√©r√©s">
                  <span class="btn-icon">üßπ</span>
                  <span class="btn-label">Effacer</span>
                </button>
              </div>

              <div class="action-pair">
                <button type="button" id="beautify-gen-output-btn">
                  <span class="btn-icon">üñºÔ∏è</span>
                  <span class="btn-label">Beautify</span>
                </button>
                <button type="button" id="minify-gen-output-btn">
                  <span class="btn-icon">üóúÔ∏è</span>
                  <span class="btn-label">Minify</span>
                </button>
              </div>
            </div>
            <div class="btn-row">
              <div class="action-pair">
                <label class="export-label">
                  Exporter en‚ÄØ:
                  <select id="gen-export-format">
                    <option value="json">JSON</option>
                    <option value="csv">CSV</option>
                    <option value="tsv">TSV</option>
                    <option value="text">Text</option>
                    <option value="joined">Joined</option>
                  </select>
                </label>
                <button data-action="download" data-target="gen-output" data-format-id="gen-export-format" type="button" aria-label="T√©l√©charger les ULID g√©n√©r√©s">
                  <span class="btn-icon">üíæ</span>
                  <span class="btn-label">T√©l√©charger</span>
                </button>
              </div>
            </div>
          </div>

        </div>

        <!-- Bloc 3 : G√©n√©rateur Requ√™te -->
        <div class="span-full even-bloc">
          <h3>üì® Requ√™te de g√©n√©ration :</h3>
          <pre id="req-gen" class="code-block">// En attente</pre>

          <div class="controls-row">
            <button data-action="copy" data-target="req-gen" type="button" aria-label="Copier la requ√™te de g√©n√©ration">
              <span class="btn-icon">üìã</span>
              <span class="btn-label">Copier</span>
            </button>            
            <button data-action="clear" data-target="req-gen" type="button" aria-label="Effacer la requ√™te de g√©n√©ration">
              <span class="btn-icon">üßπ</span>
              <span class="btn-label">Effacer</span>
            </button>
          </div>
        </div>

      </div>
    </section>


    <!-- ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë -->
    <!-- ‚ñë‚ñë‚ñë 3. Autofill JSON ‚ñë‚ñë‚ñë -->
    <!-- ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë -->
    <section class="component">
      <h2>üß™ Autofill JSON</h2>
      <div class="row">

        <!-- Bloc 1 : Autofill Entr√©e + Params -->
        <div>

          <div class="form-group even-bloc">
            <label for="json-input">Entr√©e JSON :</label>
            <textarea id="json-input" rows="8" placeholder='{"key_uid":null}'></textarea>
            <div id="json-validity" class="mini-text"></div> <!-- L'indicateur de validit√© JSON -->
            <div class="action-container">
              <div class="action-pair">
                <button type="button" id="paste-json-btn" aria-label="Coller le JSON √† remplir">
                  <span class="btn-icon">üì•</span>
                  <span class="btn-label">Coller</span>
                </button>
                <button data-action="clear" data-target="json-input" type="button" aria-label="Effacer le JSON √† remplir">
                  <span class="btn-icon">üßº</span>
                  <span class="btn-label">Effacer</span>
                </button>
              </div>        
              <div class="action-pair">
                <button type="button" id="beautify-autofill-input-btn">
                  <span class="btn-icon">üñºÔ∏è</span>
                  <span class="btn-label">Beautify</span>
                </button>
                <button type="button" id="minify-autofill-input-btn">
                  <span class="btn-icon">üóúÔ∏è</span>
                  <span class="btn-label">Minify</span>
                </button>
              </div>
            </div>
          </div>

          <!-- 2.1 Cl√© et valeur -->
            <div class="field-pair odd-bloc">
              <div>
                <label for="autofill-key">Cl√© terminant par :</label>
                <input id="autofill-key" value="_uid" placeholder="_uid | ...">
              </div>
              <div>
                <label for="autofill-value">Valeur √† remplacer :</label>
                <input id="autofill-value" value="null" placeholder="null | ... | *">
              </div>
            </div>

          <!-- 2.1 Cl√©s √† ins√©rer -->
          <div id="autofill-keys">
            <label for="autofill-keys" class="sortable-list even-bloc">
              <span class="span-list-title">Cl√©s √† ins√©rer</span>
              <div class="list-item">
                <div class="left-group">
                  <input type="checkbox" id="autofill-key-unix" checked>
                  <label for="autofill-key-unix">t (UNIX)</label>
                </div>
                <div class="move-controls">
                  <button type="button" class="up-btn">‚ñ≤</button>
                  <button type="button" class="down-btn">‚ñº</button>
                </div>
              </div>
              <div class="list-item">
                <div class="left-group">
                  <input type="checkbox" id="autofill-key-iso" checked>
                  <label for="autofill-key-iso">ts (ISO 8601)</label>
                </div>
                <div class="move-controls">
                  <button type="button" class="up-btn">‚ñ≤</button>
                  <button type="button" class="down-btn">‚ñº</button>
                </div>
              </div>
              <div class="list-item">
                <div class="left-group">
                  <input type="checkbox" id="autofill-key-ulid" checked>
                  <label for="autofill-key-ulid">ulid (Base32/Hexa - Bin)</label>
                </div>
                <div class="move-controls">
                  <button type="button" class="up-btn">‚ñ≤</button>
                  <button type="button" class="down-btn">‚ñº</button>
                </div>
              </div>
            </label>
          </div>

          <!-- 2.1 Base et binaire -->
          <div class="field-pair odd-bloc">
            <div>
              <label for="autofill-base">Base :</label>
              <select id="autofill-base">
                <option value="crockford">Base32 (Crockford)</option>
                <option value="hex">Hexa</option>
              </select>
            </div>
            <label for="autofill-bin" class="checkbox-stack">
              <span>Inclure binaire</span>
              <input type="checkbox" id="autofill-bin">
            </label>
          </div>

          <!-- 2.1 Timestamp commun -->
          <div>
            <label for="autofill-ts-common-selectbox" class="checkbox-stack even-bloc">
              <span>Timestamp commun</span>
              <div id="autofill-ts-common-selectbox" class="ts-select">
                <div class="option selected" data-value="no">Non</div>
                <div class="option" data-value="now">Maintenant</div>
                <div class="option" data-value="custom">Personnalis√©</div>
              </div>
            </label>
          </div>

          <!-- 2.1 Type + valeur du timestamp custom -->
          <div class="ts-radio-group odd-bloc">
            <label class="ts-radio-line">
              <input type="radio" id="autofill-ts-type-unix" name="autofill-ts-type" value="unix">
              <span class="label">UNIX (ms)</span>
              <input id="autofill-ts-input-unix" class="ts-input" placeholder="299575380000" readonly>
              <span id="autofill-ts-valid-unix" class="ts-valid"></span>
            </label>
            <label class="ts-radio-line">
              <input type="radio" id="autofill-ts-type-iso" name="autofill-ts-type" value="iso" checked>
              <span class="label">ISO 8601</span>
              <input id="autofill-ts-input-iso" class="ts-input" placeholder="1979-06-30T07:23:00.000Z" readonly>
              <span id="autofill-ts-valid-iso" class="ts-valid"></span>
            </label>
            <label class="ts-radio-line">
              <input type="radio" id="autofill-ts-type-crock" name="autofill-ts-type" value="crock">
              <span class="label">Crockford</span>
              <input id="autofill-ts-input-crock" class="ts-input" placeholder="01HZY9AJ4Z" readonly>
              <span id="autofill-ts-valid-crock" class="ts-valid"></span>
            </label>
          </div>

          <!-- 2.1 Bouton ¬´ Maintenant ¬ª + date humanis√©e -->
          <div class="even-bloc">
            <button type="button" id="autofill-ts-now" class="maintenant-btn" aria-label="Remplir avec la date et l'heure actuelle">‚è≤Ô∏è Maintenant</button>
            <pre id="autofill-ts-preview" class="code-block ts-preview">üìÜ Date : ‚Äî</pre>
          </div>

          <!-- 2.1 ULID monotone -->
          <div class="field-pair odd-bloc">
            <label for="autofill-gen-monotonic-ulid" class="checkbox-stack">
              <span>ULID monotones</span>
              <input type="checkbox" id="autofill-gen-monotonic-ulid">
            </label>
          </div>

        </div>

        <!-- Bloc 2 : Autofill Sortie -->
        <div>
          <!-- 2.2 Bouton "Remplir" -->
          <div class="controls-row">
            <button type="button" id="autofill-btn" class="btn-action" aria-label="Remplir le JSON avec des ULID">
              <span class="btn-icon">üìù</span>
              <span class="btn-label">Remplir</span>
            </button>
          </div>

          <!-- 2.2 Bloc de sortie -->
          <div class="even-bloc">
            <label for="json-output">Sortie JSON :</label>
            <pre id="json-output" class="code-block-out-autofill">// En attente</pre>
            <div id="autofill-count" class="mini-text"></div> <!-- Le compteur de remplacements -->
            <div class="action-container">
              <div class="action-pair">
                <button data-action="copy" data-target="json-output" type="button" aria-label="Copier le JSON g√©n√©r√©">
                  <span class="btn-icon">üìã</span>
                  <span class="btn-label">Copier</span>
                </button>
                <button data-action="clear" data-target="json-output" type="button" aria-label="Effacer le JSON g√©n√©r√©">
                  <span class="btn-icon">üßπ</span>
                  <span class="btn-label">Effacer</span>
                </button>
              </div>
              <div class="action-pair">
                <button type="button" id="beautify-autofill-output-btn">
                  <span class="btn-icon">üñºÔ∏è</span>
                  <span class="btn-label">Beautify</span>
                </button>
                <button type="button" id="minify-autofill-output-btn">
                  <span class="btn-icon">üóúÔ∏è</span>
                  <span class="btn-label">Minify</span>
                </button>
              </div>
            </div>
            <div class="btn-row">
              <div class="action-pair">
                <button data-action="download" data-target="json-output" type="button" aria-label="T√©l√©charger le JSON g√©n√©r√©">
                  <span class="btn-icon">üíæ</span>
                  <span class="btn-label">T√©l√©charger</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Bloc 3 : Autofill requ√™te -->
        <div class="span-full even-bloc">
          <h3>üì® Requ√™te d'autofill :</h3>
          <pre id="req-autofill-full" class="code-block-req-autofill">// En attente</pre>
          <div class="controls-row">
            <button data-action="copy" data-target="req-autofill-full" type="button" aria-label="Copier la requ√™te d'autofill">
              <span class="btn-icon">üìã</span>
              <span class="btn-label">Copier</span>
            </button>
            <button data-action="clear" data-target="req-autofill-full" type="button" aria-label="Effacer la requ√™te d'autofill">
              <span class="btn-icon">üßπ</span>
              <span class="btn-label">Effacer</span>
            </button>
          </div>
        </div>

      </div>
    </section>

  </main>

  <footer>ulid-worker ‚Ä¢ Cod√© avec üíö par Rapha√´l et ü§ñ ‚Ä¢Licence CC BY-NC-SA 4.0</footer>

  <script type="module">
      
    import {
      encodeTime, decodeCrock, formatFullDate,
      validateJSON, showToast, debounce,
      setValid, clearValid,
      generateUlidOfficial,
      rawToBinary,
      autofillJsonStructure,
      checkUlid
    } from '/helpers.js';

    // ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
    // ‚îÇ  üîî  TOAST STYLES                                           ‚îÇ
    // ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
    .toast {
      position: fixed;
      bottom: 1rem; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: #fff; padding: .5rem 1rem;
      border-radius: 4px; z-index: 9999;
      font-family: sans-serif;
    }`;
    document.head.append(toastStyle);

    // ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
    // ‚îÇ  üß∞  DOM HELPERS                                            ‚îÇ
    // ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ
    const $ = (id) => document.getElementById(id);

    /* D√©tection des cl√©s s√©lectionn√©es et de leur ordre */
    function getSelectedKeys(containerId) {
      const container = document.getElementById(containerId)?.querySelector('.sortable-list');
      if (!container) return [];

      const keys = [];
      container.querySelectorAll('.list-item').forEach(item => {
        const input = item.querySelector('input[type="checkbox"]');
        const label = item.querySelector('label');
        if (input?.checked && label) {
          const text = label.textContent.trim();
          if (text.includes('UNIX')) keys.push('t');
          else if (text.includes('ISO')) keys.push('ts');
          else if (text.includes('ulid')) keys.push('ulid');
          else console.warn('cl√© inconnue', text);
        }
      });

      return keys;
    }
    /* Fin de D√©tection des cl√©s s√©lectionn√©es et de leur ordre */

    // ‚îÄ‚îÄ‚îÄ Beautify / Minify JSON ‚îÄ‚îÄ‚îÄ
    function beautifyGenOutput() {
      const pre = $("gen-output");
      try {
        const obj = JSON.parse(pre.textContent);
        pre.textContent = JSON.stringify(obj, null, 2);
        updateJsonValidity();
      } catch {
        showToast("‚ùå JSON invalide !");
      }
    }

    function minifyGenOutput() {
      const pre = $("gen-output");
      try {
        const obj = JSON.parse(pre.textContent);
        pre.textContent = JSON.stringify(obj);
        updateJsonValidity();
      } catch {
        showToast("‚ùå JSON invalide !");
      }
    }

    function beautifyAutofillInput() {
      const input = $("json-input");
      try {
        const obj = JSON.parse(input.value);
        input.value = JSON.stringify(obj, null, 2);
        updateJsonValidity();
      } catch {
        showToast("‚ùå JSON invalide !");
      }
    }

    function minifyAutofillInput() {
      const input = $("json-input");
      try {
        const obj = JSON.parse(input.value);
        input.value = JSON.stringify(obj);
        updateJsonValidity();
      } catch {
        showToast("‚ùå JSON invalide !");
      }
    }

    function beautifyAutofillOutput() {
      const pre = $("json-output");
      try {
        const obj = JSON.parse(pre.textContent);
        pre.textContent = JSON.stringify(obj, null, 2);
        updateJsonValidity();
      } catch {
        showToast("‚ùå JSON invalide !");
      }
    }

    function minifyAutofillOutput() {
      const pre = $("json-output");
      try {
        const obj = JSON.parse(pre.textContent);
        pre.textContent = JSON.stringify(obj);
        updateJsonValidity();
      } catch {
        showToast("‚ùå JSON invalide !");
      }
    }

    // === üìã Copier texte (2 spans btn-icon / btn-label) ===
    // -----------------------------------------------
    // Copie le contenu de l'√©l√©ment (#id) et met √† jour
    // l'ic√¥ne et le texte du bouton pour indiquer succ√®s/√©chec.
      window.copyText = (id, event, btnOverride) => {
        const el = document.getElementById(id);
        if (!el) return;
        const text = el.value || el.textContent || el.innerText;
        const btn = btnOverride || event.currentTarget;

      const iconSpan  = btn.querySelector('.btn-icon');
      const labelSpan = btn.querySelector('.btn-label');

      const origIcon  = iconSpan  ? iconSpan.textContent  : '';
      const origLabel = labelSpan ? labelSpan.textContent : btn.innerText;

      navigator.clipboard.writeText(text)
        .then(() => {
          if (iconSpan && labelSpan) {
            iconSpan.textContent  = '‚úîÔ∏è';
            labelSpan.textContent = 'Copi√© !';
          } else {
            btn.innerText = '‚úîÔ∏è Copi√© !';
          }
        })
        .catch(() => {
          if (iconSpan && labelSpan) {
            iconSpan.textContent  = '‚ùå';
            labelSpan.textContent = '√âchec';
          } else {
            btn.innerText = '‚ùå √âchec';
          }
        })
        .finally(() => {
          btn.disabled = true;
          setTimeout(() => {
            if (iconSpan && labelSpan) {
              iconSpan.textContent  = origIcon;
              labelSpan.textContent = origLabel;
            } else {
              btn.innerText = origIcon + ' ' + origLabel;
            }
            btn.disabled = false;
          }, 3000);
        });
    };

    // === üì• Coller depuis le presse-papier ===
    // -----------------------------------------------
    // Lit le texte du clipboard et le colle dans #targetId.
    // Si `callback` est fourni, on l'appelle avec le texte.
    window.pasteTo = async (targetId, callback) => {
      try {
        const text = await navigator.clipboard.readText();
        const el = $(targetId);
        if (!text || !el) return;
        el.value = text;
        if (typeof callback === "function") callback(text);
      } catch (err) {
        alert("‚ùå Impossible de coller : " + err.message);
      }
    };

    /* ---------------------------------------------------------------
      üß™ Autofill JSON ‚Äî nouvelle version
      ---------------------------------------------------------------
      - Lit les trois check-boxes d'insertion (Unix / ISO / ULID)
      - Construit un param√®tre  fields=t,ts,ulid  pass√© au Worker
      - V√©rifie qu'au moins une case est coch√©e
      - Affiche la requ√™te, appelle /autofill, affiche le r√©sultat
      - Met √† jour le compteur de remplacements
    ---------------------------------------------------------------- */
    window.autofillJSON = async () => {
      const btn = $("autofill-btn");
      btn.disabled = true;
      btn.classList.add("pending");

      // 1. Lecture du JSON et de l'UI
      const rawInput = $("json-input").value;
      let jsonInput;
      try { jsonInput = JSON.parse(rawInput); }
      catch {
        showToast("‚ùå JSON invalide !");
        btn.disabled = false;
        btn.classList.remove("pending");
        return;
      }
      const keySuffixClean  = $("autofill-key").value.trim()   || "_uid";
      const rawValueMatch   = $("autofill-value").value.trim() || "null";
      let matchValueFn;
      if (rawValueMatch === "*" || rawValueMatch === "") {
        matchValueFn = () => true;
      } else {
        let parsedValue;
        try { parsedValue = JSON.parse(rawValueMatch); matchValueFn = (val) => val === parsedValue; }
        catch { matchValueFn = (val) => String(val) === rawValueMatch; }
      }
      const base     = $("autofill-base").value;
      const bin      = $("autofill-bin").checked;
      const mono     = $("autofill-gen-monotonic-ulid").checked;
      const tsParam  = getAutofillTsParam();
      const fields   = getSelectedKeys('autofill-keys');
      if (!fields.length) {
        showToast("‚ö†Ô∏è Choisis au moins un champ √† ins√©rer !");
        btn.disabled = false;
        btn.classList.remove("pending");
        return;
      }
      let forcedTs = null;
      if (tsParam && tsParam.startsWith('&timestamp=')) {
        forcedTs = Number(tsParam.slice('&timestamp='.length));
        if (!Number.isFinite(forcedTs)) forcedTs = null;
      }

      // 2. Appel du helper centralis√© (le vrai DRY !)
      const { result, count } = await autofillJsonStructure(jsonInput, {
        keySuffix: keySuffixClean,
        matchValueFn,
        fields,
        mono,
        forcedTs,
        bin
      });

      $("json-output").textContent = JSON.stringify(result, null, 2);

      // Requ√™te simul√©e (pour la transparence UX)
      const url =
        `/autofill`
        + `?key=${encodeURIComponent(keySuffixClean)}&value=${encodeURIComponent(rawValueMatch)}`
        + `&base=${base}`
        + (bin ? "&bin=true" : "")
        + (mono ? "&monotonic=true" : "")
        + (tsParam || "")
        + "&fields=" + fields.join(",");
      $("req-autofill-full").textContent =
        `POST ${url}\nContent-Type: application/json\n\n`
        + JSON.stringify(jsonInput, null, 2);

      $("autofill-count").textContent =
        count
          ? `üîÑ ${count} remplacement(s) effectu√©(s)`
          : `‚ÑπÔ∏è Aucun remplacement`;

      btn.disabled = false;
      btn.classList.remove("pending");
    }; // ‚Üê fin de AutofillJSON()

    // === üíæ Utilitaire g√©n√©rique pour t√©l√©charger un r√©sultat ===
    // -----------------------------------------------
    // G√©n√®re un nom de fichier horodat√© + ULID, cr√©e un Blob
    // et d√©clenche le t√©l√©chargement.

    // === s√©curise les champs CSV/TSV ===
    function escapeField(field, delim) {
      if (typeof field !== 'string') field = String(field ?? '');
      if (field.includes(delim) || field.includes('"') || field.includes('\n') || field.includes('\r')) {
        return '"' + field.replace(/"/g, '""') + '"';
      }
      return field;
    }

    // === downloadResult v2 ===
    async function downloadResult(outputId, formatId) {
      const format = formatId ? (document.getElementById(formatId)?.value || 'json') : 'json';
      const raw = document.getElementById(outputId).textContent.trim();
      if (!raw || raw.startsWith("//")) {
        alert("Aucune donn√©e √† exporter !");
        return;
      }

      const now = new Date();
      const pad = n => String(n).padStart(2, "0");
      const datePart = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}`;

      let fileUlid = "noid";
      try {
        const ulidRes = await fetch("/ulid?n=1&format=text");
        if (ulidRes.ok) fileUlid = (await ulidRes.text()).trim();
      } catch {}

      const filename = `${datePart}_${fileUlid}.${format}`;

      let result = raw;
      try {
        const parsed = JSON.parse(raw);
        const isArray = Array.isArray(parsed);

        if ((format === "csv" || format === "tsv" || format === "text" || format === "joined") && isArray) {
          const delim = format === "csv" ? "," : format === "tsv" ? "\t" : "\n";
          const fields = getSelectedKeys('gen-keys'); // ‚¨ÖÔ∏è tr√®s important : ordre sortable-list

          const allValues = [];
          for (const field of fields) {
            for (const obj of parsed) {
              if (typeof obj === "object" && obj[field] !== undefined) {
                allValues.push(String(obj[field]));
              } else if (typeof obj !== "object" && field === "ulid") {
                allValues.push(String(obj)); // cas primitif (ulid seul)
              }
            }
          }

          if (format === "csv" || format === "tsv") {
            result = allValues.map(val => escapeField(val, delim)).join(delim);
          } else if (format === "text") {
            result = allValues.join("\n\n");
          } else if (format === "joined") {
            result = allValues.join("");
          }
        }

        else if (format === "json") {
          result = raw; // üéØ R√©plique directe du contenu affich√©
        }

      } catch {
        // si JSON.parse √©choue => on garde raw
      }

      const blob = new Blob([result], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // === üíæ Raccourcis pour Playground ===
    window.downloadConverted = () =>
      downloadResult("gen-output", "gen-export-format");

    window.downloadAutofill  = () =>
      downloadResult("json-output", "autofill-export-format");

    // === üîé V√©rification ULID ===
    // -----------------------------------------------
    // Lit le champ, appelle /ulid?check=‚Ä¶ et affiche
    // la r√©ponse formatt√©e ou une erreur en console.
    window.checkULID = async () => {
      const btn = $("check-btn");
      btn.disabled = true;
      btn.classList.add("pending");

      try {
        const input = $("check-input").value.trim().toUpperCase();
        if (!input) {
          showToast("‚ö†Ô∏è Entrez un ULID √† v√©rifier.");
          return;
        }

        // Utilise le helper checkUlid pour v√©rification locale
        const res = checkUlid(input);

        // Simule la requ√™te pour l'affichage
        const url = `/ulid?check=${encodeURIComponent(input)}`;
        $("req-check").textContent = `GET ${url}`;

        if (!res.ok) {
          $("check-output").textContent = JSON.stringify({ error: res.error }, null, 2);
          $("check-ts-preview").textContent = "üìÜ Date : ‚Äî";
          showToast("‚ùå " + res.error);
        } else {
          const out = {
            conform: true,
            t: res.t,
            ts: res.ts,
            ulid: input,
            // Ajoute d'autres infos si tu veux les exposer
          };
          $("check-output").textContent = JSON.stringify(out, null, 2);
          $("check-ts-preview").textContent = "üìÜ Date : " + formatFullDate(res.ts);
        }
        $("check-output").scrollTop = 0;
      }
      finally {
        btn.disabled = false;
        btn.classList.remove("pending");
      }
    };

    // === üé≤ G√©n√©ration ULID ===
    // -----------------------------------------------
    // Construit l'URL /ulid avec tes options
    // + flags timestamp et monotonic, affiche la requ√™te,
    // puis met √† jour gen-output.
    window.generateULID = async () => {
      const btn = $("generate-btn");
      btn.disabled = true;
      btn.classList.add("pending");
    
      const n         = +$("gen-count").value || 1;
      const base      = $("gen-base").value;
      const bin       = $("gen-bin").checked;
      const format    = $("gen-format").value;
      const mono      = $("gen-monotonic-ulid").checked;
      const fields    = getSelectedKeys('gen-keys');
      const tsParam   = getGenTsParam();
      // timestamp custom (sinon null)
      let forcedTs = null;
      if (tsParam && tsParam.startsWith('&timestamp=')) {
        forcedTs = Number(tsParam.slice('&timestamp='.length));
        if (!Number.isFinite(forcedTs)) forcedTs = null;
      }
    
      if (!fields.length) {
        showToast("‚ö†Ô∏è Choisis au moins un champ √† g√©n√©rer !");
        btn.disabled = false;
        btn.classList.remove("pending");
        return;
      }
    
      // Monotonicit√© (tr√®s simple ici‚ÄØ: g√©n√®re un timestamp unique pour tous, 
      // puis incr√©mente +1ms √† chaque ULID si mono)
      let tsList = [];
      if (mono && forcedTs !== null) {
        for (let i=0; i<n; ++i) tsList.push(forcedTs + i);
      } else if (mono) {
        const now = Date.now();
        for (let i=0; i<n; ++i) tsList.push(now + i);
      } else if (forcedTs !== null) {
        for (let i=0; i<n; ++i) tsList.push(forcedTs);
      } else {
        for (let i=0; i<n; ++i) tsList.push(null);
      }
    
      // G√©n√®re tous les ULID demand√©s (vraiment identique √† l‚ÄôAPI)
      const results = [];
      for (let i = 0; i < n; i++) {
        const ulid = await generateUlidOfficial(tsList[i]);
        // Formatage binaire si demand√©
        let ulidBin = null;
        if (bin) {
          ulidBin = rawToBinary(ulid);
        }
        // Conversion t / ts
        let t = decodeCrock(ulid.slice(0,10));
        let ts = new Date(t).toISOString();
    
        // Composition de l'objet r√©sultat
        const obj = {};
        for (const key of fields) {
          if (key === "t") obj.t = t;
          else if (key === "ts") obj.ts = ts;
          else if (key === "ulid") obj.ulid = ulid;
        }
        if (bin && fields.includes("ulid")) obj.bin = ulidBin;
        // Si un seul champ, simplifie
        if (fields.length === 1) {
          if (fields[0] === "t") results.push(t);
          else if (fields[0] === "ts") results.push(ts);
          else if (fields[0] === "ulid" && bin) results.push({ ulid, bin: ulidBin });
          else if (fields[0] === "ulid") results.push(ulid);
          else results.push(obj);
        } else {
          results.push(obj);
        }
      }
    
      // --- FORMAT FINAL (csv/tsv/json/text/joined) ---
      let output;
      let isText = false;
      const delim = format === "csv" ? "," :
                    format === "tsv" ? "\t" :
                    format === "text" ? "\n\n" :
                    "";
      if (["csv","tsv"].includes(format)) {
        // headers dynamiques
        const headers = [...fields];
        if (bin && fields.includes("ulid")) headers.push("bin");
        const rows = results.map(row =>
          headers.map(h => (typeof row === "object" ? row[h] : row)).join(delim)
        );
        output = [headers.join(delim), ...rows].join("\n");
        isText = true;
      } else if (["text","joined"].includes(format)) {
        let vals = results.map(row =>
          typeof row === "object" && row.ulid ? row.ulid : row
        );
        output = (format === "joined") ? vals.join("") : vals.join("\n\n");
        isText = true;
      } else { // JSON pretty
        output = JSON.stringify(results, null, 2);
        isText = false;
      }
    
      $("gen-output").textContent = output;
      $("gen-output").scrollTop = 0;
    
      btn.disabled = false;
      btn.classList.remove("pending");
    };

    /**
     * Disable / enable a "bin" checkbox depending on the current
     * value of an adjacent <select> that offers "crockford" | "hex".
     * @param {HTMLSelectElement} select  e.g. #gen-base
     * @param {HTMLInputElement}  chk     e.g. #gen-bin
     */
    function syncBinCheckbox(select, chk) {
      const isHex = select.value === 'hex';
      chk.disabled = isHex;
      if (isHex) chk.checked = false;        // uncheck when locked
    }

    // === ‚úÖ Validation JSON en temps r√©el ===
    // -----------------------------------------------
    // Affiche "‚úÖ JSON valide" ou "‚ùå JSON invalide" sous
    // la textarea, avec debounce pour ne pas spammer.
    const updateJsonValidity = debounce(() => {
      const textarea  = $("json-input");
      const validityEl= $("json-validity");
      const isValid   = validateJSON(textarea.value);
      validityEl.textContent = isValid ? "‚úÖ JSON valide" : "‚ùå JSON invalide";
      validityEl.style.color   = isValid ? "#33ff33" : "#ff4444";
    }, 300);

    // === üöÄ Init DOMContentLoaded ‚Äî liaison des handlers ===
    document.addEventListener("DOMContentLoaded", () => {

      /* Mise √† jour dynamique des fl√®ches apr√®s chaque mouvement */
      function updateMoveButtons(containerId) {
        const container = document.getElementById(containerId);
        // si on n'a pas ce bloc sur la page, on ne fait rien
        if (!container) return;
        const items = container.querySelectorAll('.list-item');

        items.forEach((item, index) => {
          const upBtn = item.querySelector('.up-btn');
          const downBtn = item.querySelector('.down-btn');

          if (upBtn) upBtn.disabled = (index === 0);
          if (downBtn) downBtn.disabled = (index === items.length - 1);
        });
      }
      /* Fin de Mise √† jour dynamique des fl√®ches apr√®s chaque mouvement */

      /* Animation fluide des boutons */
      const containers = ['gen-keys', 'autofill-keys'];

      containers.forEach(id => {
        const wrapper = document.getElementById(id);
        if (!wrapper) return;

        const container = wrapper.querySelector('.sortable-list');
        if (!container) return;

        container.addEventListener('click', (e) => {
          const btn = e.target.closest('button');
          if (!btn) return;

          const item = btn.closest('.list-item');
          if (!item || !container.contains(item)) return;

          const list = Array.from(container.querySelectorAll('.list-item'));
          const firstRects = new Map();
          list.forEach(el => firstRects.set(el, el.getBoundingClientRect()));

          if (btn.classList.contains('up-btn') && item.previousElementSibling?.classList.contains('list-item')) {
            container.insertBefore(item, item.previousElementSibling);
            updateMoveButtons('gen-keys');
            updateMoveButtons('autofill-keys');
          }
          if (btn.classList.contains('down-btn') && item.nextElementSibling?.classList.contains('list-item')) {
            container.insertBefore(item.nextElementSibling, item);
            updateMoveButtons('gen-keys');
            updateMoveButtons('autofill-keys');
          }

          animateListItems(container, firstRects);
        });
      });

      function animateListItems(container, firstRects) {
        container.querySelectorAll('.list-item').forEach(el => {
          const lastRect = el.getBoundingClientRect();
          const firstRect = firstRects.get(el);
          const deltaY = firstRect.top - lastRect.top;
          if (deltaY !== 0) {
            el.animate([
              { transform: `translateY(${deltaY}px)` },
              { transform: 'translateY(0)' }
            ], {
              duration: 300,
              easing: 'cubic-bezier(0.4, 0, 0.2, 1)'
            });
          }
        });
      }
      /* Fin de l'Animation fluide des boutons */

      /* ‚è≤Ô∏è Initialise les deux widgets Timestamp */
      window.getGenTsParam      = initTimestampUI("gen");
      window.getAutofillTsParam = initTimestampUI("autofill");

      // Nouveau : boutons Beautify / Minify
      $("beautify-gen-output-btn")?.addEventListener("click", beautifyGenOutput);
      $("minify-gen-output-btn")?.addEventListener("click",  minifyGenOutput);
      $("beautify-autofill-input-btn")?.addEventListener("click", beautifyAutofillInput);
      $("minify-autofill-input-btn")?.addEventListener("click",  minifyAutofillInput);
      $("beautify-autofill-output-btn")?.addEventListener("click", beautifyAutofillOutput);
      $("minify-autofill-output-btn")?.addEventListener("click",  minifyAutofillOutput);

      // Validation JSON √† chaque frappe
      $("json-input")?.addEventListener("input", updateJsonValidity);

      // Touches Entr√©e pour d√©clencher generate/check
      $("gen-count")?.addEventListener("keydown", e => {
        if (e.key==="Enter") { e.preventDefault(); generateULID(); }
      });
      $("check-input")?.addEventListener("keydown", e => {
        if (e.key==="Enter") { e.preventDefault(); checkULID(); }
      });

      // Boutons paste
      [
        { id:"paste-json-btn",  tgt:"json-input", callback:updateJsonValidity },
        { id:"paste-ulid-btn",  tgt:"check-input" }
      ].forEach(({id,tgt,callback}) => {
        $(id)?.addEventListener("click", () => pasteTo(tgt, callback));
      });

      // Actions principales
      [
        {id:"generate-btn",         fn:generateULID},
        {id:"check-btn",            fn:checkULID},
        {id:"autofill-btn",         fn:autofillJSON},
      ].forEach(({id, fn}) => {
        document.getElementById(id)?.addEventListener("click", fn);
      });

      // === üéõÔ∏è Gestion unifi√©e des boutons copy / clear / download ===
      document.body.addEventListener("click", e => {
        const btn = e.target.closest("[data-action]");
        if (!btn) return;

        const { action, target, formatId } = btn.dataset;
        if (!target) return;

        // Clear le champ cible
        if (action === "clear") {
          const el = $(target);
          if (!el) return;
          if ("value" in el) el.value = "";
          else el.textContent = "// En attente";

          // Appel optionnel de updateJsonValidity
          if (target === "json-input") updateJsonValidity();

          // üéØ Ajout sp√©cial pour effacer aussi la date du V√©rificateur
          if (target === "check-output") {
            const tsEl = document.getElementById("check-ts-preview");
            if (tsEl) tsEl.textContent = "üìÜ Date : ‚Äî";
          }
        }

        // Copier le champ cible
        if (action === "copy") {
          copyText(target, e, btn);
        }

        // T√©l√©charger le champ cible avec le format pr√©cis√©
        if (action === "download") {
          downloadResult(target, formatId);
        }
      });

      // D√©sactive les fl√®ches haut et bas inutiles
      updateMoveButtons('gen-keys');
      updateMoveButtons('autofill-keys');

    });

    /* ---------- Outils horodatage ---------- */

    /** Gen√®re toutes les fonctions / listeners du mini-UI Timestamp
     *  @param {string} prefix  "gen"  ou "autofill"
     *  @returns {()=>string}   fonction qui renvoie "&timestamp=‚Ä¶" ou ""
     */
    function initTimestampUI(prefix) {
      // IDs dynamiques
      const selBox = $(`${prefix}-ts-common-selectbox`);
      // ‚Ü™ si on n'a pas ce widget sur la page, on sort en renvoyant une no-op
      if (!selBox) {
        return () => "";
      }
      const isoRad = $(`${prefix}-ts-type-iso`);
      const unixRad= $(`${prefix}-ts-type-unix`);
      const crockRad=$(`${prefix}-ts-type-crock`);
      const isoIn  = $(`${prefix}-ts-input-iso`);
      const unixIn = $(`${prefix}-ts-input-unix`);
      const crockIn= $(`${prefix}-ts-input-crock`);
      const vIso   = $(`${prefix}-ts-valid-iso`);
      const vUnix  = $(`${prefix}-ts-valid-unix`);
      const vCrock = $(`${prefix}-ts-valid-crock`);
      const preview= $(`${prefix}-ts-preview`);
      const nowBtn = $(`${prefix}-ts-now`);
      const options= selBox.querySelectorAll(".option");

      let mode="no";         // no | now | custom
      let type="iso";        // iso | unix | crock

      /* ---------- helpers UI ---------- */
      const clearIndicators = () => clearValid(vIso,vUnix,vCrock);

      const syncAndPreview = () => {
        clearIndicators();
        let raw, ms, ok=false;

        if (type==="iso") {
          raw = isoIn.value.trim();
          if (!raw) { preview.textContent="üìÜ Date : ‚Äî"; return; }
          ms = Date.parse(raw);           ok=!isNaN(ms); setValid(vIso,ok);
        } else if (type==="unix") {
          raw = unixIn.value.trim();
          if (!raw) { preview.textContent="üìÜ Date : ‚Äî"; return; }
          ms = Number(raw);               ok=Number.isFinite(ms)&&ms>0; setValid(vUnix,ok);
        } else {
          raw = crockIn.value.trim();
          if (!raw) { preview.textContent="üìÜ Date : ‚Äî"; return; }
          ms = decodeCrock(raw);          ok=!isNaN(ms); setValid(vCrock,ok);
        }

        if (!ok) { preview.textContent="üìÜ Date : ‚Äî"; return; }

        // synchro des trois champs
        isoIn.value   = new Date(ms).toISOString();
        unixIn.value  = String(ms);
        crockIn.value = encodeTime(ms);
        preview.textContent = "üìÜ Date : " + formatFullDate(new Date(ms).toISOString());
      };

      const applyType = () => {
        [isoIn,unixIn,crockIn].forEach(i=>i.readOnly=true);
        if (type==="iso") isoIn.readOnly=false;
        if (type==="unix")unixIn.readOnly=false;
        if (type==="crock")crockIn.readOnly=false;
        clearIndicators();  preview.textContent="üìÜ Date : ‚Äî";
      };

      const setMode = m =>{
        mode=m; options.forEach(o=>o.classList.toggle("selected",o.dataset.value===m));
        const custom = m==="custom";
        [isoRad,unixRad,crockRad].forEach(r=>r.disabled=!custom);
        if (!custom){
          [isoIn,unixIn,crockIn].forEach(i=>{i.readOnly=true;i.value="";});
          preview.textContent="üìÜ Date : ‚Äî";
        } else {
          // ISO par d√©faut
          isoRad.checked=true; type="iso"; applyType();
        }
      };

      /* ---------- listeners ---------- */
      options.forEach(o=>o.addEventListener("click",()=>setMode(o.dataset.value)));
      [isoRad,unixRad,crockRad].forEach(r=>{
        r.addEventListener("change",()=>{
          type = isoRad.checked?"iso":unixRad.checked?"unix":"crock";
          applyType(); syncAndPreview();
        });
      });
      [isoIn,unixIn,crockIn].forEach(i=>i.addEventListener("input",syncAndPreview));

      nowBtn?.addEventListener("click",()=>{
        const ms=Date.now();
        isoIn.value=new Date(ms).toISOString();
        unixIn.value=String(ms);
        crockIn.value=encodeTime(ms);
        isoRad.checked=true; type="iso"; applyType();
        setValid(vIso,true);
        preview.textContent="üìÜ Date : "+ formatFullDate(new Date(ms).toISOString());
      });

      // init
      setMode("no");

      /* ---------- fonction utilitaire renvoy√©e ---------- */
      return () => {
        if (mode==="now")         return `&timestamp=${Date.now()}`;
        if (mode!=="custom")      return "";
        // custom
        const ms = type==="iso"   ? Date.parse(isoIn.value.trim())
                  : type==="unix" ? Number(unixIn.value.trim())
                  : decodeCrock(crockIn.value.trim());
        return (!ms||isNaN(ms)) ? "" : `&timestamp=${ms}`;
      };
    }

  </script>

  <!-- enfin ton script principal -->
  <script type="module" src="/site.js"></script>

</body>
  <script>
    // S√©curit√© anti-FOUC en cas de navigation dynamique :
    const t = localStorage.getItem('theme');
    if (t && document.documentElement.getAttribute('data-theme') !== t) {
      document.documentElement.setAttribute('data-theme', t);
    }
  </script>
</html>
